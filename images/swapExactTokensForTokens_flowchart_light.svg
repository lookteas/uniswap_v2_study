<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1400 2000">
  <defs>
    <!-- æµ…è‰²ç§‘æŠ€é£æ ¼æ¸å˜ -->
    <linearGradient id="bgGrad" x1="0%" y1="0%" x2="100%" y2="100%">
      <stop offset="0%" style="stop-color:#f8fafc;stop-opacity:1" />
      <stop offset="50%" style="stop-color:#e8f4f8;stop-opacity:1" />
      <stop offset="100%" style="stop-color:#f0f4ff;stop-opacity:1" />
    </linearGradient>
    
    <linearGradient id="headerGrad" x1="0%" y1="0%" x2="100%" y2="0%">
      <stop offset="0%" style="stop-color:#00d4ff;stop-opacity:1" />
      <stop offset="50%" style="stop-color:#7b2ff7;stop-opacity:1" />
      <stop offset="100%" style="stop-color:#f107a3;stop-opacity:1" />
    </linearGradient>
    
    <linearGradient id="processGrad" x1="0%" y1="0%" x2="100%" y2="100%">
      <stop offset="0%" style="stop-color:#00c6ff;stop-opacity:0.9" />
      <stop offset="100%" style="stop-color:#0072ff;stop-opacity:0.9" />
    </linearGradient>
    
    <linearGradient id="decisionGrad" x1="0%" y1="0%" x2="100%" y2="100%">
      <stop offset="0%" style="stop-color:#f857a6;stop-opacity:0.9" />
      <stop offset="100%" style="stop-color:#ff5858;stop-opacity:0.9" />
    </linearGradient>
    
    <linearGradient id="successGrad" x1="0%" y1="0%" x2="100%" y2="100%">
      <stop offset="0%" style="stop-color:#11998e;stop-opacity:0.9" />
      <stop offset="100%" style="stop-color:#38ef7d;stop-opacity:0.9" />
    </linearGradient>
    
    <linearGradient id="errorGrad" x1="0%" y1="0%" x2="100%" y2="100%">
      <stop offset="0%" style="stop-color:#ff416c;stop-opacity:0.9" />
      <stop offset="100%" style="stop-color:#ff4b2b;stop-opacity:0.9" />
    </linearGradient>
    
    <linearGradient id="loopGrad" x1="0%" y1="0%" x2="100%" y2="100%">
      <stop offset="0%" style="stop-color:#7f00ff;stop-opacity:0.9" />
      <stop offset="100%" style="stop-color:#e100ff;stop-opacity:0.9" />
    </linearGradient>
    
    <linearGradient id="stepGrad" x1="0%" y1="0%" x2="0%" y2="100%">
      <stop offset="0%" style="stop-color:#ff416c;stop-opacity:1" />
      <stop offset="100%" style="stop-color:#ff4b2b;stop-opacity:1" />
    </linearGradient>
    
    <linearGradient id="dataGrad" x1="0%" y1="0%" x2="100%" y2="100%">
      <stop offset="0%" style="stop-color:#f7971e;stop-opacity:0.9" />
      <stop offset="100%" style="stop-color:#ffd200;stop-opacity:0.9" />
    </linearGradient>
    
    <!-- å‘å…‰æ•ˆæœ -->
    <filter id="glow" x="-50%" y="-50%" width="200%" height="200%">
      <feGaussianBlur stdDeviation="3" result="coloredBlur"/>
      <feMerge>
        <feMergeNode in="coloredBlur"/>
        <feMergeNode in="SourceGraphic"/>
      </feMerge>
    </filter>
    
    <filter id="glowStrong" x="-50%" y="-50%" width="200%" height="200%">
      <feGaussianBlur stdDeviation="6" result="coloredBlur"/>
      <feMerge>
        <feMergeNode in="coloredBlur"/>
        <feMergeNode in="SourceGraphic"/>
      </feMerge>
    </filter>
    
    <filter id="shadow" x="-20%" y="-20%" width="140%" height="140%">
      <feDropShadow dx="0" dy="4" stdDeviation="8" flood-color="#000" flood-opacity="0.15"/>
    </filter>
    
    <!-- ç®­å¤´æ ‡è®° -->
    <marker id="arrowCyan" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
      <polygon points="0 0, 10 3.5, 0 7" fill="#0072ff"/>
    </marker>
    <marker id="arrowGreen" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
      <polygon points="0 0, 10 3.5, 0 7" fill="#11998e"/>
    </marker>
    <marker id="arrowRed" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
      <polygon points="0 0, 10 3.5, 0 7" fill="#ff4b2b"/>
    </marker>
    <marker id="arrowPurple" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
      <polygon points="0 0, 10 3.5, 0 7" fill="#7f00ff"/>
    </marker>
    
    <!-- ç½‘æ ¼èƒŒæ™¯å›¾æ¡ˆ -->
    <pattern id="grid" width="40" height="40" patternUnits="userSpaceOnUse">
      <path d="M 40 0 L 0 0 0 40" fill="none" stroke="#c0d0e0" stroke-width="0.5" opacity="0.5"/>
    </pattern>
  </defs>
  
  <!-- æµ…è‰²ç§‘æŠ€èƒŒæ™¯ -->
  <rect width="1400" height="2000" fill="url(#bgGrad)"/>
  <rect width="1400" height="2000" fill="url(#grid)"/>
  
  <!-- è£…é¥°æ€§åœ†ç¯ -->
  <circle cx="100" cy="100" r="80" fill="none" stroke="#00d4ff" stroke-width="1" opacity="0.3"/>
  <circle cx="1300" cy="1900" r="120" fill="none" stroke="#f107a3" stroke-width="1" opacity="0.3"/>
  <circle cx="1350" cy="200" r="60" fill="none" stroke="#7b2ff7" stroke-width="1" opacity="0.2"/>
  
  <!-- ==================== æ ‡é¢˜åŒºåŸŸ ==================== -->
  <rect x="100" y="30" width="1200" height="100" rx="20" fill="rgba(255,255,255,0.9)" stroke="url(#headerGrad)" stroke-width="2" filter="url(#shadow)"/>
  <text x="700" y="70" text-anchor="middle" fill="url(#headerGrad)" font-size="32" font-weight="bold" font-family="Arial, sans-serif" filter="url(#glow)">
    swapExactTokensForTokens() å¤šè·³äº¤æ¢æµç¨‹
  </text>
  <text x="700" y="105" text-anchor="middle" fill="#5a6a7a" font-size="14" font-family="Arial, sans-serif">
    æºç : UniswapV2Router02.sol ç¬¬ 224-237 è¡Œ | å†…éƒ¨å‡½æ•° _swap() ç¬¬ 212-223 è¡Œ
  </text>
  
  <!-- ==================== Step 1: ç”¨æˆ·è°ƒç”¨å…¥å£ ==================== -->
  <g transform="translate(450, 160)">
    <!-- åºå·åœ†åœˆ -->
    <circle cx="0" cy="40" r="22" fill="url(#stepGrad)" filter="url(#glow)"/>
    <text x="0" y="47" text-anchor="middle" fill="white" font-size="16" font-weight="bold" font-family="Arial, sans-serif">1</text>
    
    <!-- èŠ‚ç‚¹ -->
    <rect x="30" y="0" width="450" height="80" rx="15" fill="rgba(255,255,255,0.95)" stroke="#0072ff" stroke-width="2" filter="url(#shadow)"/>
    <text x="255" y="30" text-anchor="middle" fill="#0072ff" font-size="16" font-weight="bold" font-family="Arial, sans-serif">
      ç”¨æˆ·è°ƒç”¨ swapExactTokensForTokens()
    </text>
    <text x="255" y="52" text-anchor="middle" fill="#5a6a7a" font-size="12" font-family="Arial, sans-serif">
      å‚æ•°: amountIn, amountOutMin, path[], to, deadline
    </text>
    <text x="255" y="70" text-anchor="middle" fill="#11998e" font-size="11" font-family="Arial, sans-serif">
      ç”¨æˆ·æŒ‡å®šå›ºå®šè¾“å…¥é‡ï¼ŒæœŸæœ›è·å¾—æœ€å°‘è¾“å‡ºé‡
    </text>
  </g>
  
  <!-- å‚æ•°è¯´æ˜æ¡† -->
  <g transform="translate(950, 160)">
    <rect x="0" y="0" width="350" height="100" rx="10" fill="rgba(255,255,255,0.9)" stroke="#f7971e" stroke-width="1.5" filter="url(#shadow)"/>
    <text x="175" y="22" text-anchor="middle" fill="#e67e00" font-size="13" font-weight="bold" font-family="Arial, sans-serif">ğŸ“‹ å‚æ•°è¯´æ˜</text>
    <text x="15" y="42" fill="#4a5568" font-size="11" font-family="Arial, sans-serif">â€¢ amountIn: å›ºå®šè¾“å…¥çš„ä»£å¸æ•°é‡</text>
    <text x="15" y="58" fill="#4a5568" font-size="11" font-family="Arial, sans-serif">â€¢ amountOutMin: æœ€å°‘æ¥å—çš„è¾“å‡ºé‡ (æ»‘ç‚¹ä¿æŠ¤)</text>
    <text x="15" y="74" fill="#4a5568" font-size="11" font-family="Arial, sans-serif">â€¢ path[]: äº¤æ¢è·¯å¾„æ•°ç»„ [tokenIn, ..., tokenOut]</text>
    <text x="15" y="90" fill="#4a5568" font-size="11" font-family="Arial, sans-serif">â€¢ deadline: äº¤æ˜“æˆªæ­¢æ—¶é—´æˆ³</text>
  </g>
  
  <!-- ç®­å¤´ -->
  <line x1="700" y1="240" x2="700" y2="290" stroke="#0072ff" stroke-width="2" marker-end="url(#arrowCyan)"/>
  
  <!-- ==================== Step 2: deadline æ£€æŸ¥ ==================== -->
  <g transform="translate(450, 300)">
    <!-- åºå·åœ†åœˆ -->
    <circle cx="50" cy="50" r="22" fill="url(#stepGrad)" filter="url(#glow)"/>
    <text x="50" y="57" text-anchor="middle" fill="white" font-size="16" font-weight="bold" font-family="Arial, sans-serif">2</text>
    
    <!-- è±å½¢åˆ¤æ–­ -->
    <polygon points="250,0 400,50 250,100 100,50" fill="rgba(255,255,255,0.95)" stroke="#f857a6" stroke-width="2" filter="url(#shadow)"/>
    <text x="250" y="45" text-anchor="middle" fill="#e91e63" font-size="14" font-weight="bold" font-family="Arial, sans-serif">
      ensure(deadline)
    </text>
    <text x="250" y="63" text-anchor="middle" fill="#5a6a7a" font-size="11" font-family="Arial, sans-serif">
      deadline â‰¥ block.timestamp ?
    </text>
  </g>
  
  <!-- deadline å¤±è´¥ -->
  <line x1="850" y1="350" x2="950" y2="350" stroke="#ff4b2b" stroke-width="2" marker-end="url(#arrowRed)"/>
  <text x="900" y="340" text-anchor="middle" fill="#ff4b2b" font-size="12" font-weight="bold" font-family="Arial, sans-serif">å¦ âœ—</text>
  
  <g transform="translate(960, 320)">
    <rect x="0" y="0" width="200" height="60" rx="10" fill="rgba(255,255,255,0.95)" stroke="#ff4b2b" stroke-width="2" filter="url(#shadow)"/>
    <text x="100" y="25" text-anchor="middle" fill="#ff4b2b" font-size="12" font-weight="bold" font-family="Arial, sans-serif">âŒ REVERT</text>
    <text x="100" y="45" text-anchor="middle" fill="#5a6a7a" font-size="10" font-family="Arial, sans-serif">'UniswapV2Router: EXPIRED'</text>
  </g>
  
  <!-- deadline æˆåŠŸ -->
  <line x1="700" y1="400" x2="700" y2="450" stroke="#11998e" stroke-width="2" marker-end="url(#arrowGreen)"/>
  <text x="720" y="430" fill="#11998e" font-size="12" font-weight="bold" font-family="Arial, sans-serif">æ˜¯ âœ“</text>
  
  <!-- ==================== Step 3: è®¡ç®— amounts æ•°ç»„ ==================== -->
  <g transform="translate(400, 460)">
    <!-- åºå·åœ†åœˆ -->
    <circle cx="0" cy="45" r="22" fill="url(#stepGrad)" filter="url(#glow)"/>
    <text x="0" y="52" text-anchor="middle" fill="white" font-size="16" font-weight="bold" font-family="Arial, sans-serif">3</text>
    
    <!-- èŠ‚ç‚¹ -->
    <rect x="30" y="0" width="540" height="90" rx="15" fill="rgba(255,255,255,0.95)" stroke="#0072ff" stroke-width="2" filter="url(#shadow)"/>
    <text x="300" y="28" text-anchor="middle" fill="#0072ff" font-size="15" font-weight="bold" font-family="Arial, sans-serif">
      è®¡ç®—æ¯ä¸€è·³çš„è¾“å…¥è¾“å‡ºé‡
    </text>
    <text x="300" y="50" text-anchor="middle" fill="#11998e" font-size="12" font-family="Arial, sans-serif">
      amounts = UniswapV2Library.getAmountsOut(factory, amountIn, path)
    </text>
    <text x="300" y="72" text-anchor="middle" fill="#5a6a7a" font-size="11" font-family="Arial, sans-serif">
      å¾ªç¯è°ƒç”¨ getAmountOut() è®¡ç®—æ¯è·³è¾“å‡º | æºç : Library ç¬¬ 62-70 è¡Œ
    </text>
  </g>
  
  <!-- amounts æ•°ç»„ç¤ºä¾‹ -->
  <g transform="translate(100, 470)">
    <rect x="0" y="0" width="280" height="80" rx="10" fill="rgba(255,255,255,0.9)" stroke="#7f00ff" stroke-width="1.5" filter="url(#shadow)"/>
    <text x="140" y="20" text-anchor="middle" fill="#7f00ff" font-size="11" font-weight="bold" font-family="Arial, sans-serif">ğŸ’¡ amounts[] æ•°ç»„ç¤ºä¾‹ (3è·³)</text>
    <text x="15" y="40" fill="#4a5568" font-size="10" font-family="Arial, sans-serif">path = [A, B, C, D]</text>
    <text x="15" y="55" fill="#4a5568" font-size="10" font-family="Arial, sans-serif">amounts = [1000, 980, 960, 940]</text>
    <text x="15" y="70" fill="#718096" font-size="9" font-family="Arial, sans-serif">æ¯è·³æ‰£é™¤ 0.3% æ‰‹ç»­è´¹åçš„è¾“å‡ºé‡</text>
  </g>
  
  <!-- ç®­å¤´ -->
  <line x1="700" y1="550" x2="700" y2="600" stroke="#0072ff" stroke-width="2" marker-end="url(#arrowCyan)"/>
  
  <!-- ==================== Step 4: æ»‘ç‚¹æ£€æŸ¥ ==================== -->
  <g transform="translate(450, 610)">
    <!-- åºå·åœ†åœˆ -->
    <circle cx="50" cy="50" r="22" fill="url(#stepGrad)" filter="url(#glow)"/>
    <text x="50" y="57" text-anchor="middle" fill="white" font-size="16" font-weight="bold" font-family="Arial, sans-serif">4</text>
    
    <!-- è±å½¢åˆ¤æ–­ -->
    <polygon points="250,0 420,50 250,100 80,50" fill="rgba(255,255,255,0.95)" stroke="#f857a6" stroke-width="2" filter="url(#shadow)"/>
    <text x="250" y="40" text-anchor="middle" fill="#e91e63" font-size="13" font-weight="bold" font-family="Arial, sans-serif">
      amounts[last] â‰¥
    </text>
    <text x="250" y="58" text-anchor="middle" fill="#e91e63" font-size="13" font-weight="bold" font-family="Arial, sans-serif">
      amountOutMin ?
    </text>
  </g>
  
  <!-- æ»‘ç‚¹æ£€æŸ¥æ³¨é‡Š -->
  <g transform="translate(100, 610)">
    <rect x="0" y="0" width="280" height="70" rx="10" fill="rgba(255,255,255,0.9)" stroke="#f7971e" stroke-width="1.5" filter="url(#shadow)"/>
    <text x="140" y="20" text-anchor="middle" fill="#e67e00" font-size="11" font-weight="bold" font-family="Arial, sans-serif">ğŸ›¡ï¸ æ»‘ç‚¹ä¿æŠ¤æ£€æŸ¥</text>
    <text x="15" y="40" fill="#4a5568" font-size="10" font-family="Arial, sans-serif">ç¡®ä¿æœ€ç»ˆè¾“å‡º â‰¥ ç”¨æˆ·è®¾å®šçš„æœ€å°å€¼</text>
    <text x="15" y="55" fill="#718096" font-size="9" font-family="Arial, sans-serif">æºç : ç¬¬ 232 è¡Œ</text>
    <text x="15" y="68" fill="#11998e" font-size="9" font-family="Arial, sans-serif">é˜²æ­¢ä»·æ ¼å‰§çƒˆæ³¢åŠ¨å¯¼è‡´æŸå¤±</text>
  </g>
  
  <!-- æ»‘ç‚¹æ£€æŸ¥å¤±è´¥ -->
  <line x1="870" y1="660" x2="970" y2="660" stroke="#ff4b2b" stroke-width="2" marker-end="url(#arrowRed)"/>
  <text x="920" y="650" text-anchor="middle" fill="#ff4b2b" font-size="12" font-weight="bold" font-family="Arial, sans-serif">å¦ âœ—</text>
  
  <g transform="translate(980, 630)">
    <rect x="0" y="0" width="280" height="60" rx="10" fill="rgba(255,255,255,0.95)" stroke="#ff4b2b" stroke-width="2" filter="url(#shadow)"/>
    <text x="140" y="25" text-anchor="middle" fill="#ff4b2b" font-size="12" font-weight="bold" font-family="Arial, sans-serif">âŒ REVERT</text>
    <text x="140" y="45" text-anchor="middle" fill="#5a6a7a" font-size="9" font-family="Arial, sans-serif">'UniswapV2Router: INSUFFICIENT_OUTPUT_AMOUNT'</text>
  </g>
  
  <!-- æ»‘ç‚¹æ£€æŸ¥æˆåŠŸ -->
  <line x1="700" y1="710" x2="700" y2="760" stroke="#11998e" stroke-width="2" marker-end="url(#arrowGreen)"/>
  <text x="720" y="740" fill="#11998e" font-size="12" font-weight="bold" font-family="Arial, sans-serif">æ˜¯ âœ“</text>
  
  <!-- ==================== Step 5: è½¬è´¦åˆ°ç¬¬ä¸€ä¸ª Pair ==================== -->
  <g transform="translate(400, 770)">
    <!-- åºå·åœ†åœˆ -->
    <circle cx="0" cy="45" r="22" fill="url(#stepGrad)" filter="url(#glow)"/>
    <text x="0" y="52" text-anchor="middle" fill="white" font-size="16" font-weight="bold" font-family="Arial, sans-serif">5</text>
    
    <!-- èŠ‚ç‚¹ -->
    <rect x="30" y="0" width="540" height="90" rx="15" fill="rgba(255,255,255,0.95)" stroke="#0072ff" stroke-width="2" filter="url(#shadow)"/>
    <text x="300" y="28" text-anchor="middle" fill="#0072ff" font-size="15" font-weight="bold" font-family="Arial, sans-serif">
      å°†è¾“å…¥ä»£å¸è½¬å…¥ç¬¬ä¸€ä¸ª Pair
    </text>
    <text x="300" y="50" text-anchor="middle" fill="#11998e" font-size="11" font-family="Arial, sans-serif">
      TransferHelper.safeTransferFrom(path[0], msg.sender, pair, amounts[0])
    </text>
    <text x="300" y="72" text-anchor="middle" fill="#5a6a7a" font-size="11" font-family="Arial, sans-serif">
      pair = pairFor(factory, path[0], path[1]) | æºç : ç¬¬ 233-235 è¡Œ
    </text>
  </g>
  
  <!-- è½¬è´¦æµç¨‹å›¾ç¤º -->
  <g transform="translate(100, 780)">
    <rect x="0" y="0" width="280" height="70" rx="10" fill="rgba(255,255,255,0.9)" stroke="#11998e" stroke-width="1.5" filter="url(#shadow)"/>
    <text x="140" y="20" text-anchor="middle" fill="#11998e" font-size="11" font-weight="bold" font-family="Arial, sans-serif">ğŸ“¤ ä»£å¸è½¬è´¦æµå‘</text>
    <text x="15" y="42" fill="#4a5568" font-size="10" font-family="Arial, sans-serif">User â†’ Pair(path[0], path[1])</text>
    <text x="15" y="58" fill="#718096" font-size="9" font-family="Arial, sans-serif">ä½¿ç”¨ pairFor() ç¦»çº¿è®¡ç®— Pair åœ°å€</text>
  </g>
  
  <!-- ç®­å¤´ -->
  <line x1="700" y1="860" x2="700" y2="910" stroke="#0072ff" stroke-width="2" marker-end="url(#arrowCyan)"/>
  
  <!-- ==================== Step 6: è°ƒç”¨ _swap å¼€å§‹å¾ªç¯ ==================== -->
  <g transform="translate(400, 920)">
    <!-- åºå·åœ†åœˆ -->
    <circle cx="0" cy="40" r="22" fill="url(#stepGrad)" filter="url(#glow)"/>
    <text x="0" y="47" text-anchor="middle" fill="white" font-size="16" font-weight="bold" font-family="Arial, sans-serif">6</text>
    
    <!-- èŠ‚ç‚¹ -->
    <rect x="30" y="0" width="540" height="80" rx="15" fill="rgba(255,255,255,0.95)" stroke="#7f00ff" stroke-width="2" filter="url(#shadow)"/>
    <text x="300" y="28" text-anchor="middle" fill="#7f00ff" font-size="15" font-weight="bold" font-family="Arial, sans-serif">
      è°ƒç”¨å†…éƒ¨å‡½æ•° _swap() å¼€å§‹å¤šè·³å¾ªç¯
    </text>
    <text x="300" y="50" text-anchor="middle" fill="#11998e" font-size="12" font-family="Arial, sans-serif">
      _swap(amounts, path, to)
    </text>
    <text x="300" y="70" text-anchor="middle" fill="#5a6a7a" font-size="11" font-family="Arial, sans-serif">
      æºç : ç¬¬ 212-223 è¡Œ | å¾ªç¯æ¬¡æ•° = path.length - 1
    </text>
  </g>
  
  <!-- ç®­å¤´ -->
  <line x1="700" y1="1000" x2="700" y2="1050" stroke="#7f00ff" stroke-width="2" marker-end="url(#arrowPurple)"/>
  
  <!-- ==================== å¾ªç¯åŒºåŸŸå¼€å§‹ ==================== -->
  <rect x="150" y="1060" width="1100" height="620" rx="20" fill="rgba(127,0,255,0.05)" stroke="#7f00ff" stroke-width="2" stroke-dasharray="10,5"/>
  <text x="700" y="1090" text-anchor="middle" fill="#7f00ff" font-size="14" font-weight="bold" font-family="Arial, sans-serif">
    ğŸ”„ FOR å¾ªç¯: i = 0; i &lt; path.length - 1; i++
  </text>
  
  <!-- ==================== Step 7: è·å–å½“å‰è·³çš„ä»£å¸å¯¹ ==================== -->
  <g transform="translate(200, 1110)">
    <!-- åºå·åœ†åœˆ -->
    <circle cx="0" cy="35" r="22" fill="url(#stepGrad)" filter="url(#glow)"/>
    <text x="0" y="42" text-anchor="middle" fill="white" font-size="16" font-weight="bold" font-family="Arial, sans-serif">7</text>
    
    <!-- èŠ‚ç‚¹ -->
    <rect x="30" y="0" width="450" height="70" rx="12" fill="rgba(255,255,255,0.95)" stroke="#0072ff" stroke-width="2" filter="url(#shadow)"/>
    <text x="255" y="25" text-anchor="middle" fill="#0072ff" font-size="13" font-weight="bold" font-family="Arial, sans-serif">
      è·å–å½“å‰è·³çš„è¾“å…¥è¾“å‡ºä»£å¸
    </text>
    <text x="255" y="45" text-anchor="middle" fill="#11998e" font-size="11" font-family="Arial, sans-serif">
      (input, output) = (path[i], path[i + 1])
    </text>
    <text x="255" y="62" text-anchor="middle" fill="#718096" font-size="10" font-family="Arial, sans-serif">
      æºç : ç¬¬ 214 è¡Œ
    </text>
  </g>
  
  <!-- ç®­å¤´ -->
  <line x1="455" y1="1180" x2="455" y2="1210" stroke="#0072ff" stroke-width="2" marker-end="url(#arrowCyan)"/>
  
  <!-- ==================== Step 8: æ’åºç¡®å®š token0 ==================== -->
  <g transform="translate(200, 1220)">
    <!-- åºå·åœ†åœˆ -->
    <circle cx="0" cy="35" r="22" fill="url(#stepGrad)" filter="url(#glow)"/>
    <text x="0" y="42" text-anchor="middle" fill="white" font-size="16" font-weight="bold" font-family="Arial, sans-serif">8</text>
    
    <!-- èŠ‚ç‚¹ -->
    <rect x="30" y="0" width="450" height="70" rx="12" fill="rgba(255,255,255,0.95)" stroke="#0072ff" stroke-width="2" filter="url(#shadow)"/>
    <text x="255" y="25" text-anchor="middle" fill="#0072ff" font-size="13" font-weight="bold" font-family="Arial, sans-serif">
      æ’åºç¡®å®š token0 (åœ°å€è¾ƒå°è€…)
    </text>
    <text x="255" y="45" text-anchor="middle" fill="#11998e" font-size="11" font-family="Arial, sans-serif">
      (token0, ) = UniswapV2Library.sortTokens(input, output)
    </text>
    <text x="255" y="62" text-anchor="middle" fill="#718096" font-size="10" font-family="Arial, sans-serif">
      æºç : ç¬¬ 215 è¡Œ | ç”¨äºç¡®å®š amount0Out vs amount1Out
    </text>
  </g>
  
  <!-- ç®­å¤´ -->
  <line x1="455" y1="1290" x2="455" y2="1320" stroke="#0072ff" stroke-width="2" marker-end="url(#arrowCyan)"/>
  
  <!-- ==================== Step 9: ç¡®å®šè¾“å‡ºå‚æ•° ==================== -->
  <g transform="translate(200, 1330)">
    <!-- åºå·åœ†åœˆ -->
    <circle cx="0" cy="40" r="22" fill="url(#stepGrad)" filter="url(#glow)"/>
    <text x="0" y="47" text-anchor="middle" fill="white" font-size="16" font-weight="bold" font-family="Arial, sans-serif">9</text>
    
    <!-- èŠ‚ç‚¹ -->
    <rect x="30" y="0" width="450" height="80" rx="12" fill="rgba(255,255,255,0.95)" stroke="#0072ff" stroke-width="2" filter="url(#shadow)"/>
    <text x="255" y="22" text-anchor="middle" fill="#0072ff" font-size="13" font-weight="bold" font-family="Arial, sans-serif">
      ç¡®å®š swap è¾“å‡ºå‚æ•°
    </text>
    <text x="255" y="42" text-anchor="middle" fill="#11998e" font-size="10" font-family="Arial, sans-serif">
      amountOut = amounts[i + 1]
    </text>
    <text x="255" y="58" text-anchor="middle" fill="#11998e" font-size="10" font-family="Arial, sans-serif">
      (amount0Out, amount1Out) = input == token0 ? (0, amountOut) : (amountOut, 0)
    </text>
    <text x="255" y="74" text-anchor="middle" fill="#718096" font-size="9" font-family="Arial, sans-serif">
      æºç : ç¬¬ 216-217 è¡Œ | åªæœ‰ä¸€ä¸ªæ–¹å‘æœ‰è¾“å‡º
    </text>
  </g>
  
  <!-- å³ä¾§è¯´æ˜æ¡† -->
  <g transform="translate(720, 1150)">
    <rect x="0" y="0" width="480" height="180" rx="12" fill="rgba(255,255,255,0.9)" stroke="#f7971e" stroke-width="1.5" filter="url(#shadow)"/>
    <text x="240" y="25" text-anchor="middle" fill="#e67e00" font-size="13" font-weight="bold" font-family="Arial, sans-serif">ğŸ’¡ amount0Out / amount1Out é€»è¾‘è¯´æ˜</text>
    <text x="20" y="50" fill="#4a5568" font-size="11" font-family="Arial, sans-serif">Pair åˆçº¦ä¸­ token0 &lt; token1 (åœ°å€æ’åº)</text>
    <text x="20" y="72" fill="#4a5568" font-size="11" font-family="Arial, sans-serif">â€¢ å¦‚æœ input == token0: è¾“å…¥ token0ï¼Œè¾“å‡º token1</text>
    <text x="40" y="90" fill="#718096" font-size="10" font-family="Arial, sans-serif">â†’ amount0Out = 0, amount1Out = amountOut</text>
    <text x="20" y="112" fill="#4a5568" font-size="11" font-family="Arial, sans-serif">â€¢ å¦‚æœ input == token1: è¾“å…¥ token1ï¼Œè¾“å‡º token0</text>
    <text x="40" y="130" fill="#718096" font-size="10" font-family="Arial, sans-serif">â†’ amount0Out = amountOut, amount1Out = 0</text>
    <text x="20" y="155" fill="#11998e" font-size="10" font-family="Arial, sans-serif">âš ï¸ Pair.swap() éœ€è¦çŸ¥é“è¾“å‡ºå“ªä¸ªä»£å¸åŠæ•°é‡</text>
    <text x="20" y="172" fill="#718096" font-size="9" font-family="Arial, sans-serif">è¾“å…¥é‡ç”± Pair è‡ªåŠ¨ä» balance - reserve è®¡ç®—</text>
  </g>
  
  <!-- ç®­å¤´ -->
  <line x1="455" y1="1410" x2="455" y2="1440" stroke="#0072ff" stroke-width="2" marker-end="url(#arrowCyan)"/>
  
  <!-- ==================== Step 10: ç¡®å®šæ¥æ”¶åœ°å€ ==================== -->
  <g transform="translate(200, 1450)">
    <!-- åºå·åœ†åœˆ -->
    <circle cx="0" cy="40" r="22" fill="url(#stepGrad)" filter="url(#glow)"/>
    <text x="0" y="47" text-anchor="middle" fill="white" font-size="16" font-weight="bold" font-family="Arial, sans-serif">10</text>
    
    <!-- èŠ‚ç‚¹ -->
    <rect x="30" y="0" width="450" height="80" rx="12" fill="rgba(255,255,255,0.95)" stroke="#e91e63" stroke-width="2" filter="url(#shadow)"/>
    <text x="255" y="22" text-anchor="middle" fill="#e91e63" font-size="13" font-weight="bold" font-family="Arial, sans-serif">
      ç¡®å®šæœ¬è·³è¾“å‡ºçš„æ¥æ”¶åœ°å€
    </text>
    <text x="255" y="45" text-anchor="middle" fill="#11998e" font-size="10" font-family="Arial, sans-serif">
      to = i &lt; path.length - 2 ? pairFor(output, path[i+2]) : _to
    </text>
    <text x="255" y="65" text-anchor="middle" fill="#718096" font-size="10" font-family="Arial, sans-serif">
      ä¸­é—´è·³ â†’ ä¸‹ä¸€ä¸ª Pair | æœ€åä¸€è·³ â†’ ç”¨æˆ·åœ°å€
    </text>
  </g>
  
  <!-- æ¥æ”¶åœ°å€è¯´æ˜ -->
  <g transform="translate(720, 1360)">
    <rect x="0" y="0" width="480" height="130" rx="12" fill="rgba(255,255,255,0.9)" stroke="#11998e" stroke-width="1.5" filter="url(#shadow)"/>
    <text x="240" y="25" text-anchor="middle" fill="#11998e" font-size="13" font-weight="bold" font-family="Arial, sans-serif">ğŸ¯ æ¥æ”¶åœ°å€ (to) çš„å…³é”®è®¾è®¡</text>
    <text x="20" y="50" fill="#4a5568" font-size="11" font-family="Arial, sans-serif">â€¢ ä¸­é—´è·³ (i &lt; path.length - 2):</text>
    <text x="40" y="68" fill="#718096" font-size="10" font-family="Arial, sans-serif">è¾“å‡ºç›´æ¥å‘é€åˆ°ä¸‹ä¸€ä¸ª Pairï¼Œæ— éœ€ç»è¿‡ Router</text>
    <text x="20" y="90" fill="#4a5568" font-size="11" font-family="Arial, sans-serif">â€¢ æœ€åä¸€è·³ (i == path.length - 2):</text>
    <text x="40" y="108" fill="#718096" font-size="10" font-family="Arial, sans-serif">è¾“å‡ºå‘é€åˆ°ç”¨æˆ·æŒ‡å®šçš„ _to åœ°å€</text>
    <text x="20" y="125" fill="#11998e" font-size="10" font-family="Arial, sans-serif">âœ¨ è¿™ç§è®¾è®¡èŠ‚çœ gasï¼Œä»£å¸ä¸ç»è¿‡ Router ä¸­è½¬</text>
  </g>
  
  <!-- ç®­å¤´ -->
  <line x1="455" y1="1530" x2="455" y2="1560" stroke="#0072ff" stroke-width="2" marker-end="url(#arrowCyan)"/>
  
  <!-- ==================== Step 11: è°ƒç”¨ Pair.swap ==================== -->
  <g transform="translate(200, 1570)">
    <!-- åºå·åœ†åœˆ -->
    <circle cx="0" cy="40" r="22" fill="url(#stepGrad)" filter="url(#glow)"/>
    <text x="0" y="47" text-anchor="middle" fill="white" font-size="16" font-weight="bold" font-family="Arial, sans-serif">11</text>
    
    <!-- èŠ‚ç‚¹ -->
    <rect x="30" y="0" width="450" height="80" rx="12" fill="rgba(255,255,255,0.95)" stroke="#11998e" stroke-width="2" filter="url(#shadow)"/>
    <text x="255" y="22" text-anchor="middle" fill="#11998e" font-size="13" font-weight="bold" font-family="Arial, sans-serif">
      è°ƒç”¨ Pair.swap() æ‰§è¡Œäº¤æ¢
    </text>
    <text x="255" y="45" text-anchor="middle" fill="#0072ff" font-size="10" font-family="Arial, sans-serif">
      IUniswapV2Pair(pairFor(input, output)).swap(
    </text>
    <text x="255" y="62" text-anchor="middle" fill="#0072ff" font-size="10" font-family="Arial, sans-serif">
      amount0Out, amount1Out, to, new bytes(0))
    </text>
    <text x="255" y="76" text-anchor="middle" fill="#718096" font-size="9" font-family="Arial, sans-serif">
      æºç : ç¬¬ 219-221 è¡Œ | data ä¸ºç©ºè¡¨ç¤ºéé—ªç”µè´·
    </text>
  </g>
  
  <!-- Pair.swap è¯´æ˜ -->
  <g transform="translate(720, 1510)">
    <rect x="0" y="0" width="480" height="140" rx="12" fill="rgba(255,255,255,0.9)" stroke="#0072ff" stroke-width="1.5" filter="url(#shadow)"/>
    <text x="240" y="25" text-anchor="middle" fill="#0072ff" font-size="13" font-weight="bold" font-family="Arial, sans-serif">âš¡ Pair.swap() å†…éƒ¨æ‰§è¡Œ</text>
    <text x="20" y="50" fill="#4a5568" font-size="10" font-family="Arial, sans-serif">1. ä¹è§‚è½¬è´¦: å…ˆå°†è¾“å‡ºä»£å¸å‘é€ç»™ to</text>
    <text x="20" y="68" fill="#4a5568" font-size="10" font-family="Arial, sans-serif">2. è®¡ç®—è¾“å…¥: amountIn = balance - reserve</text>
    <text x="20" y="86" fill="#4a5568" font-size="10" font-family="Arial, sans-serif">3. éªŒè¯ K å€¼: balance0Adj * balance1Adj â‰¥ k * 1000Â²</text>
    <text x="20" y="104" fill="#4a5568" font-size="10" font-family="Arial, sans-serif">4. æ›´æ–°å‚¨å¤‡: _update(balance0, balance1)</text>
    <text x="20" y="122" fill="#718096" font-size="9" font-family="Arial, sans-serif">æºç : UniswapV2Pair.sol ç¬¬ 159-187 è¡Œ</text>
    <text x="20" y="137" fill="#11998e" font-size="9" font-family="Arial, sans-serif">æ‰‹ç»­è´¹åœ¨ K å€¼éªŒè¯ä¸­éšå¼æ‰£é™¤ (0.3%)</text>
  </g>
  
  <!-- å¾ªç¯ç®­å¤´ -->
  <path d="M 455 1650 L 455 1670 L 180 1670 L 180 1130 L 200 1130" fill="none" stroke="#7f00ff" stroke-width="2" stroke-dasharray="8,4" marker-end="url(#arrowPurple)"/>
  <text x="170" y="1400" fill="#7f00ff" font-size="12" font-weight="bold" font-family="Arial, sans-serif" transform="rotate(-90, 170, 1400)">
    i++ ç»§ç»­ä¸‹ä¸€è·³
  </text>
  
  <!-- å¾ªç¯ç»“æŸæ¡ä»¶ -->
  <g transform="translate(500, 1650)">
    <rect x="0" y="0" width="200" height="30" rx="8" fill="rgba(255,255,255,0.9)" stroke="#7f00ff" stroke-width="1.5"/>
    <text x="100" y="20" text-anchor="middle" fill="#7f00ff" font-size="11" font-family="Arial, sans-serif">
      i == path.length - 1 æ—¶é€€å‡º
    </text>
  </g>
  
  <!-- ==================== å¾ªç¯åŒºåŸŸç»“æŸ ==================== -->
  
  <!-- ç®­å¤´åˆ°æœ€ç»ˆå®Œæˆ -->
  <line x1="700" y1="1680" x2="700" y2="1730" stroke="#11998e" stroke-width="2" marker-end="url(#arrowGreen)"/>
  
  <!-- ==================== Step 12: äº¤æ¢å®Œæˆ ==================== -->
  <g transform="translate(350, 1740)">
    <!-- åºå·åœ†åœˆ -->
    <circle cx="0" cy="40" r="22" fill="url(#stepGrad)" filter="url(#glow)"/>
    <text x="0" y="47" text-anchor="middle" fill="white" font-size="16" font-weight="bold" font-family="Arial, sans-serif">12</text>
    
    <!-- èŠ‚ç‚¹ -->
    <rect x="30" y="0" width="620" height="80" rx="15" fill="rgba(255,255,255,0.95)" stroke="#11998e" stroke-width="3" filter="url(#glowStrong)"/>
    <text x="340" y="28" text-anchor="middle" fill="#11998e" font-size="16" font-weight="bold" font-family="Arial, sans-serif">
      ğŸ‰ äº¤æ¢å®Œæˆï¼Œè¿”å› amounts æ•°ç»„
    </text>
    <text x="340" y="52" text-anchor="middle" fill="#0072ff" font-size="12" font-family="Arial, sans-serif">
      return amounts; // [è¾“å…¥é‡, ä¸­é—´é‡..., æœ€ç»ˆè¾“å‡ºé‡]
    </text>
    <text x="340" y="72" text-anchor="middle" fill="#5a6a7a" font-size="11" font-family="Arial, sans-serif">
      ç”¨æˆ·æ”¶åˆ° amounts[amounts.length - 1] æ•°é‡çš„ç›®æ ‡ä»£å¸
    </text>
  </g>
  
  <!-- ==================== 3è·³ç¤ºä¾‹å›¾ ==================== -->
  <g transform="translate(100, 1850)">
    <rect x="0" y="0" width="1200" height="120" rx="15" fill="rgba(255,255,255,0.9)" stroke="#0072ff" stroke-width="2" filter="url(#shadow)"/>
    <text x="600" y="25" text-anchor="middle" fill="#0072ff" font-size="14" font-weight="bold" font-family="Arial, sans-serif">
      ğŸ“Š 3è·³äº¤æ¢ç¤ºä¾‹: ETH â†’ USDC â†’ WBTC â†’ UNI
    </text>
    
    <!-- ä»£å¸èŠ‚ç‚¹ -->
    <circle cx="100" cy="75" r="30" fill="rgba(255,255,255,0.95)" stroke="#627eea" stroke-width="2" filter="url(#shadow)"/>
    <text x="100" y="80" text-anchor="middle" fill="#627eea" font-size="11" font-weight="bold" font-family="Arial, sans-serif">ETH</text>
    
    <circle cx="350" cy="75" r="30" fill="rgba(255,255,255,0.95)" stroke="#2775ca" stroke-width="2" filter="url(#shadow)"/>
    <text x="350" y="80" text-anchor="middle" fill="#2775ca" font-size="11" font-weight="bold" font-family="Arial, sans-serif">USDC</text>
    
    <circle cx="600" cy="75" r="30" fill="rgba(255,255,255,0.95)" stroke="#f7931a" stroke-width="2" filter="url(#shadow)"/>
    <text x="600" y="80" text-anchor="middle" fill="#f7931a" font-size="11" font-weight="bold" font-family="Arial, sans-serif">WBTC</text>
    
    <circle cx="850" cy="75" r="30" fill="rgba(255,255,255,0.95)" stroke="#ff007a" stroke-width="2" filter="url(#shadow)"/>
    <text x="850" y="80" text-anchor="middle" fill="#ff007a" font-size="11" font-weight="bold" font-family="Arial, sans-serif">UNI</text>
    
    <circle cx="1100" cy="75" r="30" fill="rgba(255,255,255,0.95)" stroke="#11998e" stroke-width="2" filter="url(#shadow)"/>
    <text x="1100" y="80" text-anchor="middle" fill="#11998e" font-size="11" font-weight="bold" font-family="Arial, sans-serif">User</text>
    
    <!-- ç®­å¤´å’Œæ ‡ç­¾ -->
    <line x1="130" y1="75" x2="310" y2="75" stroke="#0072ff" stroke-width="2" marker-end="url(#arrowCyan)"/>
    <text x="220" y="65" text-anchor="middle" fill="#5a6a7a" font-size="9" font-family="Arial, sans-serif">Pair(ETH,USDC)</text>
    <text x="220" y="95" text-anchor="middle" fill="#11998e" font-size="9" font-family="Arial, sans-serif">i=0, to=Pair2</text>
    
    <line x1="380" y1="75" x2="560" y2="75" stroke="#0072ff" stroke-width="2" marker-end="url(#arrowCyan)"/>
    <text x="470" y="65" text-anchor="middle" fill="#5a6a7a" font-size="9" font-family="Arial, sans-serif">Pair(USDC,WBTC)</text>
    <text x="470" y="95" text-anchor="middle" fill="#11998e" font-size="9" font-family="Arial, sans-serif">i=1, to=Pair3</text>
    
    <line x1="630" y1="75" x2="810" y2="75" stroke="#0072ff" stroke-width="2" marker-end="url(#arrowCyan)"/>
    <text x="720" y="65" text-anchor="middle" fill="#5a6a7a" font-size="9" font-family="Arial, sans-serif">Pair(WBTC,UNI)</text>
    <text x="720" y="95" text-anchor="middle" fill="#11998e" font-size="9" font-family="Arial, sans-serif">i=2, to=User</text>
    
    <line x1="880" y1="75" x2="1060" y2="75" stroke="#11998e" stroke-width="2" marker-end="url(#arrowGreen)"/>
    <text x="970" y="65" text-anchor="middle" fill="#11998e" font-size="9" font-family="Arial, sans-serif">æœ€ç»ˆè¾“å‡º</text>
  </g>
  
  <!-- å›¾ä¾‹ -->
  <g transform="translate(100, 1740)">
    <rect x="0" y="0" width="220" height="90" rx="10" fill="rgba(255,255,255,0.9)" stroke="#a0aec0" stroke-width="1" filter="url(#shadow)"/>
    <text x="110" y="20" text-anchor="middle" fill="#4a5568" font-size="12" font-weight="bold" font-family="Arial, sans-serif">å›¾ä¾‹</text>
    <circle cx="25" cy="42" r="12" fill="url(#stepGrad)"/>
    <text x="50" y="47" fill="#4a5568" font-size="10" font-family="Arial, sans-serif">æ‰§è¡Œåºå·</text>
    <rect x="120" y="32" width="20" height="20" rx="3" fill="none" stroke="#e91e63" stroke-width="2"/>
    <text x="150" y="47" fill="#4a5568" font-size="10" font-family="Arial, sans-serif">åˆ¤æ–­</text>
    <rect x="15" y="62" width="20" height="15" rx="3" fill="none" stroke="#0072ff" stroke-width="2"/>
    <text x="45" y="74" fill="#4a5568" font-size="10" font-family="Arial, sans-serif">å¤„ç†</text>
    <rect x="100" y="62" width="20" height="15" rx="3" fill="none" stroke="#11998e" stroke-width="2"/>
    <text x="130" y="74" fill="#4a5568" font-size="10" font-family="Arial, sans-serif">æˆåŠŸ</text>
    <rect x="170" y="62" width="20" height="15" rx="3" fill="none" stroke="#ff4b2b" stroke-width="2"/>
    <text x="200" y="74" fill="#4a5568" font-size="10" font-family="Arial, sans-serif">é”™è¯¯</text>
  </g>
</svg>
